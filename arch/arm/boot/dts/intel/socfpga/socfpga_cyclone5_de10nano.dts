// SPDX-License-Identifier: GPL-2.0+
/*
 * Copyright (C) 2017, Intel Corporation
 *
 * based on socfpga_cyclone5_de0_nano_soc.dts
 */
/dts-v1/;

#include "socfpga_cyclone5.dtsi"
#include <dt-bindings/interrupt-controller/irq.h>
#include <dt-bindings/gpio/gpio.h>

/ {
	model = "Terasic DE10-Nano";
	compatible = "terasic,de10-nano", "altr,socfpga-cyclone5", "altr,socfpga";

	chosen {
		stdout-path = "serial0:115200n8";
	};

	memory@0 {
		/* 1 GiB */
		device_type = "memory";
		reg = <0x0 0x40000000>;
	};

	soc {
		fpga: bus@ff200000 {
			compatible = "simple-bus";
			reg = <0xff200000 0x00200000>;
			ranges = <0x00000000 0xff200000 0x00200000>;
			#address-cells = <1>;
			#size-cells = <1>;

			/*
			 * Here the devices will appear if an FPGA image is
			 * loaded. Their description is expected to be added
			 * using a device tree overlay that matches the image.
			 */
		};
	};
};

&gmac1 {
	/* Uses a KSZ9031RNX phy */
	phy-mode = "rgmii-id";
	rxd0-skew-ps = <420>;
	rxd1-skew-ps = <420>;
	rxd2-skew-ps = <420>;
	rxd3-skew-ps = <420>;
	txen-skew-ps = <0>;
	rxdv-skew-ps = <420>;
	status = "okay";
};

&gpio0 {
	status = "okay";
};

&gpio1 {
	status = "okay";
};

&gpio2 {
	status = "okay";
};

&i2c0 {
	clock-frequency = <100000>;
	status = "okay";

	accelerometer@53 {
		compatible = "adi,adxl345";
		reg = <0x53>;
		/* HPS_GSENSOR_INT is routed to UART0_RX/CAN0_RX/SPIM0_SS1/HPS_GPIO61 */
		interrupt-parent = <&portc>;
		interrupts = <3 IRQ_TYPE_LEVEL_HIGH>;
		interrupt-names = "INT1";
	};
};

&mmc0 {
	/* micro SD card socket J11 */
	status = "okay";
};

&uart0 {
	/*
	 * Accessible via USB (FT232R) on Mini-USB plug J4
	 * RX = TRACE_D0/SPIS0_CLK/UART0_RX/HPS_GPIO49
	 * TX = TRACE_D1/SPIS0_MOSI/UART0_TX/HPS_GPIO50
	 * no handshaking lines
	 */
	clock-frequency = <100000000>;
};

// https://github.com/analogdevicesinc/linux/blob/main/arch/arm/boot/dts/intel/socfpga/socfpga_cyclone5_de10_nano_hps.dtsi

/ {
	sys_clk: sys_clk {
		#clock-cells = <0x0>;
		compatible = "fixed-clock";
		clock-frequency = <50000000>;
		clock-output-names = "sys_clk";
	};

	ref_clk: ref_clk {
		#clock-cells = <0x0>;
		compatible = "fixed-clock";
		clock-frequency = <50000000>;
		clock-output-names = "reference_clock";
	};

	// REVISIT: Technically, this is a child clock of the h2f_user0_clock
	sys_dma_clk: sys_dma_clk {
		#clock-cells = <0x0>;
		compatible = "fixed-clock";
		clock-frequency = <80000000>;
		clock-output-names = "sys_dma_clk";
	};

	ltc2308_vref: voltage-regulator {
		compatible = "regulator-fixed";
		regulator-name = "fixed-supply";
		regulator-min-microvolt = <4096000>;
		regulator-max-microvolt = <4096000>;
		regulator-always-on;
	};
};

&fpga {
	gpio_bd: gpio_bd@10080 {
		compatible = "altr,pio-18.1", "altr,pio-1.0";
		reg = <0x00010080 0x10>;
		interrupt-parent = <&intc>;
		interrupts = <0 40 IRQ_TYPE_LEVEL_HIGH>;
		altr,interrupt-type = <IRQ_TYPE_LEVEL_HIGH>;
		#gpio-cells = <2>;
		gpio-controller;
		#interrupt-cells = <2>;
		interrupt-controller;
	};

	gpio_in: gpio_in@10100 {
		compatible = "altr,pio-18.1", "altr,pio-1.0";
		reg = <0x00010100 0x10>;
		interrupt-parent = <&intc>;
		interrupts = <0 42 IRQ_TYPE_LEVEL_HIGH>;
		altr,interrupt-type = <IRQ_TYPE_LEVEL_HIGH>;
		#gpio-cells = <2>;
		gpio-controller;
		#interrupt-cells = <2>;
		interrupt-controller;
	};

	axi_sysid_0: axi-sysid-0@18000 {
		compatible = "adi,axi-sysid-1.00.a";
		reg = <0x00018000 0x8000>;
	};

	hdmi_tx_dma: dma@80000 {
		compatible = "adi,axi-dmac-1.00.a";
		reg = <0x00080000 0x800>;
		interrupt-parent = <&intc>;
		interrupts = <0 47 IRQ_TYPE_LEVEL_HIGH>;
		#dma-cells = <1>;
		clocks = <&sys_clk>;
	};

	axi_hdmi@90000 {
		compatible = "adi,axi-hdmi-tx-1.00.a";
		reg = <0x00090000 0x10000>;
		dmas = <&hdmi_tx_dma 0>;
		dma-names = "video";
		clocks = <&pixel_clock 0>;
		adi,is-rgb;

		port {
			axi_hdmi_out: endpoint {
				remote-endpoint = <&adv7513_in>;
			};
		};
	};

	pixel_clock: fpll@100000 {
		#clock-cells = <0x1>;
		compatible = "altr,c5-fpll";
		reg = <0x00100000 0x100>;
		#address-cells = <1>;
		#size-cells = <0>;
		clocks = <&ref_clk>;
		assigned-clocks = <&pixel_clock 0>, <&pixel_clock 1>;
		assigned-clock-rates = <148500000>, <100000000>;
		clock-output-names = "c5_out0", "c5_out1", "c5_out2",
				     "c5_out3", "c5_out4", "c5_out5",
				     "c5_out6", "c5_out7", "c5_out8";
		adi,fractional-carry-bit = <32>;

		fpll_c0: channel@0 {
			reg = <0>;
			adi,extended-name = "PIXEL_CLOCK";
		};

		fpll_c1: channel@1 {
			reg = <1>;
			adi,extended-name = "DMA_CLOCK";
		};
	};

	gpio_out: gpio_out@109000 {
		compatible = "altr,pio-1.0";
		reg = <0x109000 0x10>;
		#gpio-cells = <2>;
		gpio-controller;
	};

	spi@10a000 {
		compatible = "altr,spi-18.1", "altr,spi-1.0";
		reg = <0x10a000 0x20>;
		interrupt-parent = <&intc>;
		interrupts = <0 43 IRQ_TYPE_LEVEL_HIGH>;
		#address-cells = <0x1>;
		#size-cells = <0x0>;

		ltc2308: adc@0 {
			compatible = "adi,ltc2308";
			reg = <0>;
			spi-max-frequency = <40000000>;
			vref-supply = <&ltc2308_vref>;
			cnv-gpios = <&gpio_out 9 GPIO_ACTIVE_HIGH>;
			#address-cells = <1>;
			#size-cells = <0>;
			channel@0 {
				reg = <0>;
			};
			channel@1 {
				reg = <1>;
			};
			channel@2 {
				reg = <2>;
			};
			channel@3 {
				reg = <3>;
			};
			channel@4 {
				reg = <4>;
			};
			channel@5 {
				reg = <5>;
			};
			channel@6 {
				reg = <6>;
			};
			channel@7 {
				reg = <7>;
			};
		};
	};
};

&i2c0 {
	adv7513@39 {
		compatible = "adi,adv7513";
		reg = <0x39>, <0x3f>;
		reg-names = "primary", "edid";

		adi,input-depth = <8>;
		adi,input-colorspace = "rgb";
		adi,input-clock = "1x";
		adi,clock-delay = <0>;

		#sound-dai-cells = <0>;

		ports {
			#address-cells = <1>;
			#size-cells = <0>;

			port@0 {
				reg = <0>;
				adv7513_in: endpoint {
					remote-endpoint = <&axi_hdmi_out>;
				};
			};

			port@1 {
				reg = <1>;
			};
		};
	};
};

// https://analogdevicesinc.github.io/hdl/projects/ad411x_ad717x/index.html


/ {
	eval_u2: eval-u2-regulator {
		compatible = "regulator-fixed";
		regulator-name = "EVAL ADUM6411BRSZ (U2)";
		// LK24 jumper default position REMOVED
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		regulator-always-on;
	};

	eval_u6: eval-u6-regulator {
		compatible = "regulator-fixed";
		regulator-name = "EVAL ADR4525BRZ (U6)";
		regulator-min-microvolt = <2500000>;
		regulator-max-microvolt = <2500000>;
		regulator-always-on;
	};
};

&fpga {
	rx_dma: dma@20000 {
		compatible = "adi,axi-dmac-1.00.a";
		reg = <0x20000 0x800>;
		#dma-cells = <1>;
		interrupt-parent = <&intc>;
		interrupts = <0 44 IRQ_TYPE_LEVEL_HIGH>;
		clocks = <&sys_clk>;
	};

	spi@30000 {
		compatible = "adi,axi-spi-engine-1.00.a";
		reg = <0x30000 0x1000>;
		interrupt-parent = <&intc>;
		interrupts = <0 45 IRQ_TYPE_LEVEL_HIGH>;
		clocks = <&sys_clk>, <&sys_dma_clk>;
		clock-names = "s_axi_aclk", "spi_clk";

		dmas = <&rx_dma 0>;
		dma-names = "offload0-rx";
		trigger-sources = <&adc_trigger>;

		#address-cells = <0x1>;
		#size-cells = <0x0>;

		adc@0 {
			compatible = "adi,ad4111";
			reg = <0>;
			
			spi-max-frequency = <20000000>;

			// S1 default position - SINGLE
			avdd-supply = <&eval_u2>;
			// LK24 jumper default position A
			iovdd-supply = <&eval_u2>;
			// LK13 jumper default position B
			vref-supply = <&eval_u6>;

			interrupts = <18 IRQ_TYPE_EDGE_FALLING>;
			interrupt-names = "rdy";
			interrupt-parent = <&gpio_in>;
			rdy-gpios = <&gpio_in 18 GPIO_ACTIVE_LOW>;

			#address-cells = <1>;
			#size-cells = <0>;

			channel@0 {
				reg = <0>;
				single-channel = <0>; // VIN0
				common-mode-channel = <16>; //VINCOM
			};

			channel@1 {
				reg = <1>;
				single-channel = <1>; // VIN1
				common-mode-channel = <16>; //VINCOM
			};

			channel@2 {
				reg = <2>;
				single-channel = <2>; // VIN2
				common-mode-channel = <16>; //VINCOM
			};

			channel@3 {
				reg = <3>;
				single-channel = <3>; // VIN3
				common-mode-channel = <16>; //VINCOM
			};

			channel@4 {
				reg = <4>;
				single-channel = <4>; // VIN4
				common-mode-channel = <16>; //VINCOM
			};

			channel@5 {
				reg = <5>;
				single-channel = <5>; // VIN5
				common-mode-channel = <16>; //VINCOM
			};

			channel@6 {
				reg = <6>;
				single-channel = <6>; // VIN6
				common-mode-channel = <16>; //VINCOM
			};

			channel@7 {
				reg = <7>;
				single-channel = <7>; // VIN7
				common-mode-channel = <16>; //VINCOM
			};

			channel@8 {
				reg = <8>;
				single-channel = <0>; // IIN0
				adi,current-channel;
			};

			channel@9 {
				reg = <9>;
				single-channel = <1>; // IIN1
				adi,current-channel;
			};

			channel@10 {
				reg = <10>;
				single-channel = <2>; // IIN2
				adi,current-channel;
			};

			channel@11 {
				reg = <11>;
				single-channel = <3>; // IIN3
				adi,current-channel;
			};
		};
	};

	adc_trigger: trigger@40000 {
		compatible = "adi,util-sigma-delta-spi";
		reg = <0x40000 0x100>;
		clocks = <&sys_dma_clk>;
		#trigger-source-cells = <0>;
	};
};
