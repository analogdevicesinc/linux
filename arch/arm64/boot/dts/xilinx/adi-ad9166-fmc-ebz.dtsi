// SPDX-License-Identifier: GPL-2.0
/*
 * dtsi file for AD9166-FMC-EBZ on Xilinx ZynqMP ZCU102 Rev 1.0
 *
 * Copyright (C) 2024-2025 Analog Devices Inc.
 */

/ {
	clocks {
		local_osc: clock@0 {
			compatible = "fixed-clock";
			clock-frequency = <122880000>; // 122.88MHz
			clock-output-names = "clkin";
			#clock-cells = <0>;
		};

	};
};

#include <dt-bindings/iio/frequency/hmc7044.h>

/ {
	fpga_axi: fpga-axi@0 {
		axi_spi_fmc: spi@85300000 {
			compatible = "xlnx,axi-quad-spi-3.2", "xlnx,xps-spi-2.00.a";
			reg = <0x85300000 0x1000>;
			#address-cells = <1>;
			#size-cells = <0>;
	
			interrupt-names = "ip2intc_irpt";
			interrupt-parent = <&gic>;
			interrupts = <0 105 IRQ_TYPE_LEVEL_HIGH>; // ps-9 in HDL
			
			clock-names = "ext_spi_clk", "s_axi_aclk";
			clocks = <&zynqmp_clk 71>, <&zynqmp_clk 71>;

			bits-per-word = <8>;
			fifo-size = <16>;
			num-cs = <0x4>;		
			xlnx,num-ss-bits = <0x4>;
			xlnx,spi-mode = <0x0>;
			xlnx,num-transfer-bits = <16>;
	
			status = "okay";
		};
	};
};

&axi_spi_fmc {
	// PL spi using AXI QUAD SPI module
	dac0_ad9166: ad9166@0 {
		//#address-cells = <1>;
		//#size-cells = <0>;
		compatible = "adi,ad9166";
		reg = <0>;
		spi-max-frequency = <1000000>;
		clocks =  <&adf4372_clk 0>;
		clock-names = "dac_clk";
		spi-cpol;
		spi-cpha;

		adi,full-scale-current-mircoamp = <40000>;
		dac_clk-clock-scales = <1 1>;
		jesd204-device;
		#jesd204-cells = <2>;
		jesd204-top-device = <0>; /* This is the TOP device */
		jesd204-link-ids = <0>;
		jesd204-inputs = <&axi_ad9166_core 0 0>;

		adi,jesd-subclass = <1>;
		adi,dac-interpolation = <2>;
		adi,channel-interpolation = <4>;
		adi,clock-output-divider = <1>;
		adi,syncoutb-signal-type-lvds-enable;
		//adi,scrambling = <1>;
		adi,sysref-mode = <2>; /* SYSREF_CONTINUOUS */
		adi,spi-3wire-enable;

		adi,subclass = <1>;			/* JESD SUBCLASS 0,1,2 */
		adi,version = <1>;			/* JESD VERSION 0=204A,1=204B,2=204C */
		adi,converters-per-device = <2>;	/* JESD M */
		adi,octets-per-frame = <1>;		/* JESD F */
		adi,frames-per-multiframe = <32>;	/* JESD K */
		adi,converter-resolution = <16>;	/* JESD N */
		adi,bits-per-sample = <16>;		/* JESD NP' */
		adi,control-bits-per-sample = <0>;	/* JESD CS */
		adi,lanes-per-device = <8>;		/* JESD L */
		adi,samples-per-converter-per-frame = <2>; /* JESD S */
		adi,interpolation = <2>;
	};

	hmc7044_clk: hmc7044@1 {
		compatible = "adi,hmc7044";
		reg = <1>;
		spi-max-frequency = <10000000>;
		#address-cells = <1>;
		#size-cells = <0>;
		#clock-cells = <1>;
		adi,spi-3wire-enable;

		// frequencies for            CLKIN0  CLKIN1      CLKIN2    CLKIN3
		adi,pll1-clkin-frequencies = <0 122880000 0 0>; // nu sunt sigura de frecventa asta
		// clock priority (least->highest): CLKIN3, CLKIN0, CLKIN1, CLKIN2 =>
		// => 11 00 01 10 = C6
		// used when giving signal from SMA (in this case for CLKN2)
		adi,pll1-ref-prio-ctrl = <0xC6>;

		adi,vcxo-frequency = <122880000>;
		// hmc7044 output frequency which will be further divided by the channel dividers
		// 2.5GHz is a convenient value for all 1.25GHz, 312.5MHz, 9.7656MHz
		adi,pll2-output-frequency = <2500000000>;

		// in the driver, it will write 0x0064[1]=1 to increase the limit to 6000MHz, from 3200MHz
		//adi,use-vco-divider;
		adi,sysref-timer-divider = <1024>;

		adi,clkin0-buffer-mode = <0x15>;
		adi,oscin-buffer-mode = <0x15>;

		adi,gpi-controls = <0x00 0x00 0x00 0x00>;
		adi,gpo-controls = <0x1f 0x2b 0x00 0x00>;

		clock-output-names = "hmc7044_out0", "hmc7044_out1", "hmc7044_out2",
				     "hmc7044_out3", "hmc7044_out4", "hmc7044_out5",
				     "hmc7044_out6", "hmc7044_out7", "hmc7044_out8",
				     "hmc7044_out9", "hmc7044_out10", "hmc7044_out11",
				     "hmc7044_out12", "hmc7044_out13";

		// pll2-output-frequency/divider

		// 1.25GHz
		// data sheet says sampled at fCLK/4 (ADF4372_RFAUX8/4)
		hmc7044_c3: channel@3 {
			reg = <3>;
			adi,extended-name = "DAC_SYSREF";
			adi,divider = <2>;
			adi,driver-mode = <1>;
		};
		// 312.5MHz
		hmc7044_c12: channel@12 {
			reg = <12>;
			adi,extended-name = "FPGA_CLK";
			adi,divider = <8>;
			adi,driver-mode = <2>;
		};
		// 9.7656MHz
		hmc7044_c13: channel@13 {
			reg = <13>;
			adi,extended-name = "FPGA_SYSREF";
			adi,divider = <256>;
			adi,driver-mode = <2>;
		};
	};

	adf4372_clk: adf4372@2 {
		compatible = "adi,adf4372";
		reg = <2>;
		spi-max-frequency = <1000000>;
		clocks = <&local_osc>;
		clock-names = "clkin"; // must be clkin

		#address-cells = <1>;
		#size-cells = <0>;
		#clock-cells = <1>;
		adi,spi-3wire-enable;

		clock-output-names = "adf4372_rf8", "adf4372_rfaux8";
		adi,muxout-select = <1>; // digital lock detect

		// o fi RF8x?
		channel@0 {
			reg = <0>;
			adi,output-enable;
			adi,power-up-frequency = /bits/ 64 <5000000000>; // 5GHz
		};

		// o fi RFAUX8x?
		channel@1 {
			reg = <1>;
			adi,output-enable;
			adi,power-up-frequency = /bits/ 64 <5000000000>; // 5GHz
		};
	};
	
	amplifier@3 {
		compatible = "adi,ad9166-amp";
		reg = <3>;
	};
};
