/dts-v1/;
/* hdl: */

#include "versal-vck190-rev1.1.dts"
#include <dt-bindings/iio/adc/adi,ad9088.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include <dt-bindings/jesd204/adxcvr.h>

#define fmc_spi spi0

#ifndef DEVICE_PROFILE_NAME
#define DEVICE_PROFILE_NAME	"id00_uc93.bin"
#endif

#define HSCI_SPEED 800

/* RX path */
#define AD9084_RX_LANERATE_KHZ	20625000
#define AD9084_RX_LINK_CLK	312500000

/* TX path */
#define AD9084_TX_LANERATE_KHZ	20625000
#define AD9084_TX_LINK_CLK	312500000

#ifndef SYSREF_CLK_MHz
#define SYSREF_CLK_MHz		(9765625)
#endif

/ {
	clocks {
		clkin_125: clock@0 {
			#clock-cells = <0>;
			compatible = "fixed-clock";
			clock-frequency = <125000000>;
			clock-output-names = "clkin_125";
		};
	};
};

&gic {
	num_cpus = <2>;
	num_interrupts = <96>;
};

&lpd_dma_chan0 {
	status = "okay";
};

&lpd_dma_chan1 {
	status = "okay";
};

&lpd_dma_chan2 {
	status = "okay";
};

&lpd_dma_chan3 {
	status = "okay";
};

&lpd_dma_chan4 {
	status = "okay";
};

&lpd_dma_chan5 {
	status = "okay";
};

&lpd_dma_chan6 {
	status = "okay";
};

&lpd_dma_chan7 {
	status = "okay";
};

&cci {
	status = "okay";
};

&smmu {
	status = "okay";
};

&gpio1 {
	status = "okay";
};

&qspi {
	is-dual = <1>;
	num-cs = <1>;
	spi-rx-bus-width = <4>;
	spi-tx-bus-width = <4>;
	status = "okay";
};

&sdhci1 {
	clock-frequency = <199999985>;
	status = "okay";
};

&serial0 {
	cts-override ;
	device_type = "serial";
	port-number = <0>;
};

&spi0 {
	is-decoded-cs = <0>;
	num-cs = <3>;
	status = "okay";
};

&spi1 {
	is-decoded-cs = <0>;
	num-cs = <3>;
	status = "okay";
};

&ttc0 {
	status = "okay";
};

&ref_clk {
	clock-frequency = <33333333>;
};

&gem0 {
	local-mac-address = [00 0a 35 ad 90 81];
};

&i2c1 {
	eeprom@50 {
		compatible = "at24,24c02";
		reg = <0x50>;
	};
	ltc2977@5c {
		compatible = "lltc,ltc2977";
		reg = <0x5C>;
	};
	ltm4681_c23@4f {
		compatible = "lltc,ltm4680";
		reg = <0x4F>;
	};
	ltm4681_c01@4e {
		compatible = "lltc,ltm4680";
		reg = <0x4E>;
	};
};

/ {
	model = "Analog Devices AD9084-FMCA-EBZ (Rev. B0) @Xilinx/vck190";

	chosen {
		bootargs = "console=ttyAMA0 earlycon=pl011,mmio32,0xFF000000,115200n8 clk_ignore_unused root=/dev/mmcblk0p2 rw rootfstype=ext4 rootwait";
		stdout-path = "serial0:115200";
	};

	fpga_axi: fpga-axi@0 {
		interrupt-parent = <&gic>;
		compatible = "simple-bus";
		#address-cells = <0x1>;
		#size-cells = <0x1>;
		ranges = <0 0 0 0xffffffff>;

		clocks {
			rx_fixed_linerate: clock@1 {
				#clock-cells = <0>;
				compatible = "fixed-clock";
				clock-frequency = <AD9084_RX_LANERATE_KHZ>;
				clock-output-names = "rx_lane_clk";
			};

			tx_fixed_linerate: clock@2 {
				#clock-cells = <0>;
				compatible = "fixed-clock";
				clock-frequency = <AD9084_TX_LANERATE_KHZ>;
				clock-output-names = "tx_lane_clk";
			};

			rx_fixed_link_clk: clock@3 {
				#clock-cells = <0>;
				compatible = "fixed-clock";
				clock-frequency = <AD9084_RX_LINK_CLK>;
				clock-output-names = "rx_link_clk";
			};

			tx_fixed_link_clk: clock@4 {
				#clock-cells = <0>;
				compatible = "fixed-clock";
				clock-frequency = <AD9084_TX_LINK_CLK>;
				clock-output-names = "tx_link_clk";
			};
		};

		axi_gpio: gpio@a4000000 {
			#gpio-cells = <2>;
			#interrupt-cells = <2>;
			clock-names = "s_axi_aclk";
			clocks = <&versal_clk PMC_PL0_REF>;
			compatible = "xlnx,axi-gpio-2.0", "xlnx,xps-gpio-1.00.a";
			gpio-controller;
			interrupt-controller;
			interrupt-names = "ip2intc_irpt";
			interrupt-parent = <&gic>;
			interrupts = <0 84 4>;
			reg = <0xa4000000 0x1000>;
			xlnx,all-inputs = <0x0>;
			xlnx,all-inputs-2 = <0x0>;
			xlnx,all-outputs = <0x0>;
			xlnx,all-outputs-2 = <0x0>;
			xlnx,dout-default = <0x00000000>;
			xlnx,dout-default-2 = <0x00000000>;
			xlnx,gpio-width = <0x20>;
			xlnx,gpio2-width = <0x20>;
			xlnx,interrupt-present = <0x1>;
			xlnx,is-dual = <0x1>;
			xlnx,tri-default = <0xFFFFFFFF>;
			xlnx,tri-default-2 = <0xFFFFFFFF>;
		};

		rx_dma: dma@bc420000 {
			compatible = "adi,axi-dmac-1.00.a";
			reg = <0xbc420000 0x10000>;
			#dma-cells = <1>;
			#clock-cells = <0>;
			interrupts = <0 97 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&versal_clk PMC_PL1_REF>;

			adi,channels {
				#size-cells = <0>;
				#address-cells = <1>;

				dma-channel@0 {
					reg = <0>;
					adi,source-bus-type = <2>;
					adi,destination-bus-type = <0>;
				};
			};
		};

		tx_dma: dma@bc430000  {
			compatible = "adi,axi-dmac-1.00.a";
			reg = <0xbc430000 0x10000>;
			#dma-cells = <1>;
			#clock-cells = <0>;
			interrupts = <0 96 IRQ_TYPE_LEVEL_HIGH>;
			clocks = <&versal_clk PMC_PL1_REF>;

			adi,channels {
				#size-cells = <0>;
				#address-cells = <1>;

				dma-channel@0 {
					reg = <0>;
					adi,source-bus-type = <0>;
					adi,destination-bus-type = <2>;
				};
			};
		};

		axi_data_offload_tx: axi-data-offload-0@bc440000 {
			compatible = "adi,axi-data-offload-1.0.a";
			reg = <0xbc440000 0x10000>;
		};

		axi_data_offload_rx: axi-data-offload-1@bc450000 {
			compatible = "adi,axi-data-offload-1.0.a";
			reg = <0xbc450000 0x10000>;
		};

		hsci_clkgen: axi-clkgen@a4ad0000  {
			compatible = "adi,axi-clkgen-2.00.a";
			reg = <0xa4ad0000 0x10000>;
			#clock-cells = <0>;
			clocks = <&versal_clk PMC_PL0_REF>, <&versal_clk PMC_PL0_REF>;
			clock-names = "s_axi_aclk", "clkin1";
			clock-output-names = "hsci_clkgen";
		};

		axi_hsci: axi_hsci@bc500000 {
			compatible = "adi,axi-hsci-1.0.a";
			reg = <0xbc500000 0x40000>;
			clocks = <&hsci_clkgen>;
			clock-names = "pclk";

			adi,hsci-interface-speed-mhz = <HSCI_SPEED>;
		};

		axi_ad9084_core_rx: axi-ad9084-rx-hpc@a4a10000 {
			compatible = "adi,axi-ad9081-rx-1.0";
			reg = <0xa4a10000 0x8000>;
			dmas = <&rx_dma 0>;
			dma-names = "rx";
			spibus-connected = <&trx0_ad9084>;

			jesd204-device;
			#jesd204-cells = <2>;
			jesd204-inputs = <&axi_ad9084_rx_jesd 0 FRAMER_LINK_A0_RX>;
		};

		axi_ad9084_core_tx: axi-ad9084-tx-hpc@a4b10000 {
			compatible = "adi,axi-ad9081-tx-1.0";
			reg = <0xa4b10000 0x4000>;
			dmas = <&tx_dma 0>;
			dma-names = "tx";
			clocks = <&trx0_ad9084 1>;
			clock-names = "sampl_clk";
			spibus-connected = <&trx0_ad9084>;
			adi,axi-pl-fifo-enable;
			adi,axi-data-offload-connected = <&axi_data_offload_tx>;

			jesd204-device;
			#jesd204-cells = <2>;
			jesd204-inputs = <&axi_ad9084_tx_jesd 0 DEFRAMER_LINK_A0_TX>;
		};

#ifdef AXI_AION_TRIG
		axi_aion_trig: axi_aion_trig@bc900000 {
			compatible = "adi,axi-aion-trig-1.0.a";
			reg = <0xbc900000 0x1000>;
			clocks = <&hmc7044 8>;
			clock-names = "device_clk";

			jesd204-device;
			#jesd204-cells = <2>;
			jesd204-inputs =
				<&hmc7044 0 FRAMER_LINK_B0_RX>,
				<&hmc7044 0 DEFRAMER_LINK_B0_TX>;

			io-channels = <&adf4030 8>;
			io-channel-names = "bsync";
		};
#endif

		axi_ad9084_rx_jesd: axi-jesd204-rx@a4a90000 {
			compatible = "adi,axi-jesd204-rx-1.0";
			reg = <0xa4a90000 0x1000>;

			interrupts = <0 95 IRQ_TYPE_LEVEL_HIGH>;

			clocks = <&versal_clk PMC_PL0_REF>, <&hmc7044 9>, <&rx_fixed_link_clk>, <&rx_fixed_linerate>;
			clock-names = "s_axi_aclk", "device_clk", "link_clk", "lane_clk";

			#clock-cells = <0>;
			clock-output-names = "jesd_rx_lane_clk";

			jesd204-device;
			#jesd204-cells = <2>;
#ifdef AXI_AION_TRIG
			jesd204-inputs = <&axi_aion_trig 0 FRAMER_LINK_A0_RX>;
#else
			jesd204-inputs = <&hmc7044 0 FRAMER_LINK_B0_RX>;
#endif

			reset-done-gpios = <&axi_gpio 32 0>;
			pll-datapath-reset-gpios = <&axi_gpio 36 0>;
			datapath-reset-gpios = <&axi_gpio 38 0>;
		};

		axi_ad9084_tx_jesd: axi-jesd204-tx@a4b90000 {
			compatible = "adi,axi-jesd204-tx-1.0";
			reg = <0xa4b90000 0x1000>;

			interrupts = <0 94 IRQ_TYPE_LEVEL_HIGH>;

			clocks = <&versal_clk PMC_PL0_REF>, <&hmc7044 8>, <&tx_fixed_link_clk>, <&tx_fixed_linerate>;
			clock-names = "s_axi_aclk", "device_clk", "link_clk", "lane_clk";

			#clock-cells = <0>;
			clock-output-names = "jesd_tx_lane_clk";

			jesd204-device;
			#jesd204-cells = <2>;
#ifdef AXI_AION_TRIG
			jesd204-inputs = <&axi_aion_trig 0 DEFRAMER_LINK_A0_TX>;
#else
			jesd204-inputs = <&hmc7044 0 DEFRAMER_LINK_B0_TX>;
#endif
			reset-done-gpios = <&axi_gpio 33 0>;
			pll-datapath-reset-gpios = <&axi_gpio 37 0>;
			datapath-reset-gpios = <&axi_gpio 39 0>;
		};

		axi_sysid_0: axi-sysid-0@a5000000 {
			compatible = "adi,axi-sysid-1.00.a";
			reg = <0xa5000000 0x10000>;
		};

		axi_spi_2: spi@a4a80000  {
			#address-cells = <1>;
			#size-cells = <0>;
			bits-per-word = <8>;
			compatible = "xlnx,axi-quad-spi-3.2", "xlnx,xps-spi-2.00.a";
			fifo-size = <16>;
			interrupt-names = "ip2intc_irpt";
			interrupt-parent = <&gic>;
			interrupts = <0 93 IRQ_TYPE_LEVEL_HIGH>;
			num-cs = <0x8>;
			reg = <0xa4a80000 0x1000>;
			xlnx,num-ss-bits = <0x8>;
			xlnx,spi-mode = <0>;
		};
	};
};


#include <dt-bindings/iio/frequency/hmc7044.h>
#include <dt-bindings/iio/adc/adi,ad9081.h>

&spi0 {
	status = "okay";

	adf4382: adf4382@0 {
		#clock-cells = <1>;
		compatible = "adi,adf4382";
		reg = <0>;
		spi-max-frequency = <5000000>;
		clocks = <&clkin_125>;
		clock-names = "ref_clk";
		clock-output-names = "adf4382_out_clk";
		adi,power-up-frequency = /bits/ 64 <20000000000>;
		label = "adf4382";
		#io-channel-cells = <1>;
	};

	hmc7044: hmc7044@1 {
		#address-cells = <1>;
		#size-cells = <0>;
		#clock-cells = <1>;
		compatible = "adi,hmc7044";
		reg = <1>;
		spi-max-frequency = <1000000>;

		jesd204-device;
		#jesd204-cells = <2>;

		clocks = <&clkin_125>;
		clock-names = "clkin0";

		jesd204-inputs =
			<&adf4030 0 FRAMER_LINK_A0_RX>,
			<&adf4030 0 DEFRAMER_LINK_A0_TX>;

		adi,pll1-clkin-frequencies = <125000000 125000000 125000000 125000000>;
		adi,vcxo-frequency = <125000000>;

		adi,pll1-loop-bandwidth-hz = <200>;

		adi,pll2-output-frequency = <2500000000>;

		adi,pll1-ref-prio-ctrl = <0xE1>; /* prefer CLKIN1 -> CLKIN0 -> CLKIN2 -> CLKIN3 */
		adi,pll1-ref-autorevert-enable;

		adi,sysref-timer-divider = <1024>;
		adi,pulse-generator-mode = <HMC7044_PULSE_GEN_CONT_PULSE>;

		adi,clkin0-buffer-mode  = <0x07>;
		adi,clkin1-buffer-mode  = <0x07>;
		adi,oscin-buffer-mode = <0x5>;

		adi,gpi-controls = <0x00 0x00 0x00 0x00>;
		adi,gpo-controls = <0x37 0x33 0x00 0x00>;

		clock-output-names =
				"hmc7044_out0", "hmc7044_out1", "hmc7044_out2",
				"hmc7044_out3", "hmc7044_out4", "hmc7044_out5",
				"hmc7044_out6", "hmc7044_out7", "hmc7044_out8",
				"hmc7044_out9", "hmc7044_out10", "hmc7044_out11",
				"hmc7044_out12", "hmc7044_out13";

		hmc7044_c1: channel@1 {
			reg = <1>;
			adi,extended-name = "ADF4030_REFIN";
			adi,divider = <20>;	// 125
			adi,driver-mode = <HMC7044_DRIVER_MODE_LVDS>;	// LVDS
		};

		hmc7044_c3: channel@3 {
			reg = <3>;
			adi,extended-name = "ADF4030_BSYNC0";
			adi,divider = <256>;	// 9.765
			adi,driver-mode = <HMC7044_DRIVER_MODE_LVPECL>;	// change to LVPECL
		};

		hmc7044_c8: channel@8 {
			reg = <8>;
			adi,extended-name = "CORE_CLK_TX";
			adi,divider = <8>;
			adi,driver-mode = <HMC7044_DRIVER_MODE_LVDS>;	// LVDS
		};

		hmc7044_c9: channel@9 {
			reg = <9>;
			adi,extended-name = "CORE_CLK_RX";
			adi,divider = <8>;
			adi,driver-mode = <HMC7044_DRIVER_MODE_LVDS>;	// LVDS
		};

		hmc7044_c10: channel@10 {
			reg = <10>;
			adi,extended-name = "FPGA_REFCLK";
			adi,divider = <8>;
			adi,driver-mode = <HMC7044_DRIVER_MODE_LVDS>;	// LVDS
		};

		hmc7044_c11: channel@11 {
			reg = <11>;
			adi,extended-name = "CORE_CLK_RX_B";
			adi,divider = <8>;
			adi,driver-mode = <HMC7044_DRIVER_MODE_LVDS>;	// LVDS
		};

		hmc7044_c12: channel@12 {
			reg = <12>;
			adi,extended-name = "CORE_CLK_TX_B";
			adi,divider = <8>;
			adi,driver-mode = <HMC7044_DRIVER_MODE_LVDS>;	// LVDS
		};
	};

	adf4030: adf4030@2 {
		#clock-cells = <1>;
		compatible = "adi,adf4030";
		reg = <2>;

		#address-cells = <1>;
		#size-cells = <0>;
		#io-channel-cells = <1>;

		spi-max-frequency = <1000000>;
		clocks = <&hmc7044 1>;
		clock-names = "refin";
		clock-output-names = "adf4030_bsync_0", "adf4030_bsync_1",
			"adf4030_bsync_2", "adf4030_bsync_3", "adf4030_bsync_4",
			"adf4030_bsync_5", "adf4030_bsync_6", "adf4030_bsync_7",
			"adf4030_bsync_8", "adf4030_bsync_9";
		label = "adf4030";

		jesd204-device;
		#jesd204-cells = <2>;

		/* The actual is axi_aion, but that does not contain a callback jesd204_cb,
		   so use this node as the beginning of the chain */
		jesd204-sysref-provider;
		adi,jesd204-max-sysref-frequency-hz = <2000000>;

		adi,vco-frequency-hz = <2500000000>; /* 2.5 GHz */
		adi,bsync-frequency-hz = <SYSREF_CLK_MHz>;
		adi,bsync-autoalign-reference-channel = <0>; /* LTC6952_OUT_6 */
		adi,bsync-autoalign-iteration-count = <6>;
		adi,bsync-secondary-frequency-hz = <12500000>; /* 12.5 MHz */

		channel@0 {
			/* hmc output */
			reg = <0>;
			adi,extended-name = "ADF4030_SCLKOUT3";
			auto-align-on-sync-en;
			adi,rcm = <1>;
			adi,link-rx-en;
			adi,float-rx-en;
		};
		channel@1 {
			/* Output debug loopback */
			reg = <1>;
			adi,extended-name = "BSYNC1_DEBUG";
			auto-align-on-sync-en;
			adi,input-output-reconfig-en;
			adi,rcm = <62>; // LVDS
			adi,link-rx-en;
			adi,float-rx-en;
			adi,output-en;
		};
		channel@2 {
			/* Input debug loopback */
			reg = <2>;
			adi,extended-name = "BSYNC2_DEBUG";
			auto-align-on-sync-en;
			adi,input-output-reconfig-en;
			adi,rcm = <62>;
			adi,link-rx-en;
			adi,float-rx-en;
		};
		channel@3 {
			reg = <3>;
			adi,extended-name = "BOGUS3";
		};
		channel@4 {
			reg = <4>;
			adi,extended-name = "BOGUS4";
		};
		channel@5 {
			/* apollo input */
			reg = <5>;
			adi,extended-name = "APOLLO_SYSREF";
			auto-align-on-sync-en;
			adi,output-en;
			adi,input-output-reconfig-en;
			adi,rcm = <1>;
			adi,link-rx-en;
			adi,float-rx-en;
		};
		channel@6 {
			reg = <6>;
			adi,extended-name = "BOGUS6";
		};
		channel@7 {
			reg = <7>;
			adi,extended-name = "BOGUS7";
		};
		channel@8 {
			/* fpga sysref_in_p/n input */
			reg = <8>;
			adi,extended-name = "SYSREF_IN_F";
			auto-align-on-sync-en;
			adi,output-en;
			adi,link-rx-en;
			adi,float-rx-en;
			adi,input-output-reconfig-en;
		};
		channel@9 {
			/* Unused, connects to nothing */
			reg = <9>;
			adi,extended-name = "SYSREF_OUT_FMC";
			adi,output-en;
			auto-align-on-sync-en;
			adi,input-output-reconfig-en;
			adi,rcm = <62>;
		};
	};
};

&axi_spi_2 {
	trx0_ad9084: ad9084@0 {
		#address-cells = <1>;
		#size-cells = <0>;
		compatible = "adi,ad9084";
		reg = <0>;
		spi-max-frequency = <13000000>;

		/* Clocks */
		clocks = <&adf4382 0>;
		clock-names = "dev_clk";
		dev_clk-clock-scales = <1 10>;

		clock-output-names = "rx_sampl_clk", "tx_sampl_clk";
		#clock-cells = <1>;

		adi,axi-hsci-connected = <&axi_hsci>;

		adi,hsci-auto-linkup-mode-en;

		jesd204-device;
		#jesd204-cells = <2>;
		jesd204-top-device = <0>; /* This is the TOP device */
		jesd204-ignore-errors;
		jesd204-link-ids = <DEFRAMER_LINK_A0_TX DEFRAMER_LINK_B0_TX FRAMER_LINK_A0_RX FRAMER_LINK_B0_RX>;

		jesd204-inputs =
			<&axi_ad9084_core_rx 0 FRAMER_LINK_A0_RX>,
			<&axi_ad9084_core_tx 0 DEFRAMER_LINK_A0_TX>;
		reset-gpios = <&axi_gpio 30 0>;

		io-channels = <&adf4030 5>, <&adf4382 0>;
		io-channel-names = "bsync", "clk";

		adi,device-profile-fw-name = DEVICE_PROFILE_NAME;

		adi,jrx0-physical-lane-mapping = <5 1 3 7 11 11 11 11 11 11 11 11>;
		adi,jtx0-logical-lane-mapping = <11 11 11 1 11 11 11 11  2  3  11 0>;

		adi,jrx1-physical-lane-mapping = <1  7 10  3  5  8  9 11 11 11 11 11>;
		adi,jtx1-logical-lane-mapping = <11 5  1  0 11  2 11  3  4  7  11 6>;

		adi,invalid-en;
	};
};
