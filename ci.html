<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Continuous integration &#8212; Linux Drivers  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8e8a900e" />
    <link rel="stylesheet" type="text/css" href="_static/app.min.css?v=47649d88" />
    <script defer="" src="_static/app.umd.js?v=9e881883"></script>
    <link rel="icon" href="_static/icon.svg"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="ADC" href="drivers/adc/index.html" />
   
  
  <meta name="repository" content="linux">
  <meta name="version" content="0.3">
  


<style>
  body {
    
  }

  body.dark {
    
  }

  @media (prefers-color-scheme: dark) {
    body:not(.light) {
      
    }
  }
</style>
  </head><body>
  <input type="checkbox" id="input-show-toc">
  <input type="checkbox" id="input-show-localtoc">
  <input type="checkbox" id="input-show-repotoc">

  
  <div class="search-area">
    <form action="" method="get">
      <input type="text" name="q" aria-labelledby="search-documentation" value="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="search" placeholder="Search"/>
      <button class="icon"></button>
    </form>
  </div>
  

  <header>
    <div id="left">
      <label id="show-sidebar" class="icon" for="input-show-toc" title="Show/hide index"></label>
    </div>
    <div id="right">
      <span>
        <a id="logo-org" href="https://analog.com"></a>
        <div class="vertical-divider"></div>
        <label id="show-repotoc" for="input-show-repotoc" title="Show/hide docs" tabindex="0">Docs</label>
        <a id="logo" href="index.html">
          <div>Linux Drivers</div>
        </a>
      </span>
      <span class="reverse">
        <label id="show-localtoc" class="icon" for="input-show-localtoc" title="Show/hide contents"></label>
      </span>
    </div>
  </header>


  <div class="repotoc-tree overlay">
    <root/>

  </div>
    <div class="localtoc">
      <div class="tocwrapper">
        <div>
          <div class="localtoc-header"></div>
          <a id="scroll-up" href="#top-anchor" title="Back to top"></a>
        </div>
        <nav>
          <ul>
<li><a class="reference internal" href="#">Continuous integration</a><ul>
<li><a class="reference internal" href="#features">Features</a><ul>
<li><a class="reference internal" href="#warning-and-error-handling">Warning and error handling</a></li>
<li><a class="reference internal" href="#checking-steps-description">Checking steps description</a></li>
<li><a class="reference internal" href="#defconfigs">Defconfigs</a></li>
<li><a class="reference internal" href="#source-code-manipulation">Source code manipulation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-up-and-running">Setting up and running</a><ul>
<li><a class="reference internal" href="#configure-podman">Configure podman</a><ul>
<li><a class="reference internal" href="#network-users-partitions">Network users &amp; partitions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-the-container-image">Build the container image</a></li>
<li><a class="reference internal" href="#interactive-run">Interactive run</a></li>
<li><a class="reference internal" href="#self-hosted-runner">Self-hosted runner</a></li>
<li><a class="reference internal" href="#self-hosted-cluster">Self-hosted cluster</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </nav>
      </div>
    </div>

  
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
    <a id="no-logo" href="index.html">
      Linux Drivers
    </a><input id="input-switch-toc" type="checkbox">
<label id="show-repotoc" for="input-switch-toc">
All content
</label>
<label id="show-toc" for="input-switch-toc">
Content on this topic
</label>
<div class="repotoc-tree">
  <root/>

</div>
<div class="toc-tree">
  <html>
  <body><ul class="current">
<li class="toctree-l1"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-1" id="toctree-collapse-1"/><div class="collapse"><a class="reference internal" href="drivers/index.html">Drivers</a><label for="toctree-collapse-1"><div class="icon"></div></label></div><ul>
<li class="toctree-l2"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-1-1" id="toctree-collapse-1-1"/><div class="collapse"><a class="reference internal" href="drivers/adc/index.html">ADC</a><label for="toctree-collapse-1-1"><div class="icon"></div></label></div><ul class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Continuous integration</a></li>
</ul>
</body>
</html>

</div>
        </div>
      </div>

  <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper" id="top-anchor">
          
          <div class="body" role="main">
            
  <section id="continuous-integration">
<span id="ci"></span><h1>Continuous integration<a class="headerlink" href="#continuous-integration" title="Link to this heading"></a></h1>
<p>Linux has a continuous deployment integration pipeline that works as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>push (main)
pull-request
┌──────┐    ┌───────────────┐    ┌──────┐
│Checks├─#─►│Build Kernel * ├─#─►│Assert│
└──────┘    └───────────────┘ ▲  └──────┘
┌────────────────┐            │
│Build Kernel arm├────────────┘
└────────────────┘
┌─────────┐    ┌──────────┐
│Build Doc├─?─►│Deploy Doc│
└─────────┘    └──────────┘
-----------------------------------------
cron
┌──────────────┐
│Update mirrors│
└──────────────┘
</pre></div>
</div>
<p>In these sections there are instructions to bring-up your own continuous integration,
either to run locally, in a self-hosted runner or even in a cluster.</p>
<p>Beyond the linear history <code class="docutils literal notranslate"><span class="pre">main</span></code> branch, the following upstream mirrors are
provided (<code class="docutils literal notranslate"><span class="pre">mirror/&lt;remote-name&gt;/&lt;branch&gt;</span></code>):</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">mirror/next/linux-next/master</span></code>: Patches aimed at the next kernel merge window</div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/log/?h=master">https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/log/?h=master</a></div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">mirror/jic23/iio/testing</span></code>: Linux IIO Subsystem (Cameron’s branch)</div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/jic23/iio.git/log/?h=testing">https://git.kernel.org/pub/scm/linux/kernel/git/jic23/iio.git/log/?h=testing</a></div>
</div>
</li>
</ul>
<p>When upstreaming a driver, target the pull-request against the mirror.</p>
<p>All of them are mirrors from the links shown with a single commit on top
that includes the CI workflows, <a class="icon git reference external" href="https://github.com/analogdevicesinc/linux/tree/main/.github/workflows/sync-mirror.yml">as simple as</a>:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>checkout<span class="w"> </span>origin/main<span class="w"> </span>--<span class="w"> </span>.github
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>checkout<span class="w"> </span>origin/main<span class="w"> </span>--<span class="w"> </span>ci
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>add<span class="w"> </span>-f<span class="w"> </span>.github<span class="w"> </span>ci
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;ci: Patch workflows&quot;</span><span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;CI generated commit&quot;</span><span class="w"> </span>-s
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>The cron job is set to update the branches at the end of every day.</p>
<section id="features">
<h2>Features<a class="headerlink" href="#features" title="Link to this heading"></a></h2>
<p>The continuous integration has some features that are described in this section.</p>
<section id="warning-and-error-handling">
<h3>Warning and error handling<a class="headerlink" href="#warning-and-error-handling" title="Link to this heading"></a></h3>
<p>Each tool will have its own outputs and the standard to consider something
an error, a warning or something else.
So the workflows separate the steps outputs into steps events named
<code class="docutils literal notranslate"><span class="pre">err</span></code>, <code class="docutils literal notranslate"><span class="pre">fail</span></code>, and <code class="docutils literal notranslate"><span class="pre">warn</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">err</span></code>: What a method return, if not captured (<code class="docutils literal notranslate"><span class="pre">||</span> <span class="pre">true</span></code>), fails the CI.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fail</span></code>: Indicates that a warning or error deemed strict was raised.
Is collected at the assert job and ends the run with failure.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">warn</span></code>: Indicates that a warning or error non-deemed strict was raised.
Is collected at the assert job and <strong>does not</strong> end the run with failure.</p></li>
</ul>
</section>
<section id="checking-steps-description">
<h3>Checking steps description<a class="headerlink" href="#checking-steps-description" title="Link to this heading"></a></h3>
<p>The purpose of the continuous integrations is to run all the latest and greatest
code checkers.
To reduce noise, the checkers are run on the commit range or changed files only,
when possible.</p>
<p>The checkers are, followed by which step event they raise:</p>
<ul>
<li><p>Check job:</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">checkpatch</span></code>: runs on every commit of the commit range.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fail</span></code>: <code class="docutils literal notranslate"><span class="pre">error</span></code> logged</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">warn</span></code>: <code class="docutils literal notranslate"><span class="pre">warning</span></code> logged</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">coccicheck</span></code>: every coccifile is applied on every changed <em>.c</em> file, using <code class="docutils literal notranslate"><span class="pre">spatch</span></code>.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">warn</span></code>: <code class="docutils literal notranslate"><span class="pre">warning</span></code> logged</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">dt_binding_check</span></code>: on every changed <em>.yaml</em> file.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">warn</span></code>: <code class="docutils literal notranslate"><span class="pre">warning</span></code> logged</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fail</span></code>: contain file name or dts example return error code</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">cppcheck</span></code>: runs on every changed file.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fail</span></code>: <code class="docutils literal notranslate"><span class="pre">error</span></code> logged</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">warn</span></code>: <code class="docutils literal notranslate"><span class="pre">warning</span></code> logged</div>
</div>
</li>
</ul>
</li>
<li><p>Build matrix job:</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">defconfig</span></code>: generate the defconfig.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">err</span></code>: returned error code</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">make</span></code>: compile kernel at head commit.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">err</span></code>: returned error code</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">compiled</span></code>: check if touched <em>.c</em> have been compiled.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fail</span></code>: <em>.o</em> file not found for touched <em>.c</em> file</div>
</div>
</li>
</ul>
</li>
<li><p>Build matrix job with checks:</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sparse</span></code>: the changed files are touched and recompiled with <code class="docutils literal notranslate"><span class="pre">C=1</span></code>.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fail</span></code>: <code class="docutils literal notranslate"><span class="pre">error</span></code> logged</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">warn</span></code>: <code class="docutils literal notranslate"><span class="pre">warning</span></code> logged</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ggc</span> <span class="pre">fanalyzer</span></code>: the changed files are recompiled appending the <code class="docutils literal notranslate"><span class="pre">-fanalyzer</span></code> flag.</div>
<div class="line">It uses the <em>compile_commands.json</em> file to extract the correct compilation flags.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fail</span></code>: <code class="docutils literal notranslate"><span class="pre">error</span></code> or <code class="docutils literal notranslate"><span class="pre">warning</span></code> logged</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">smatch</span></code>: the changed files are touched and recompiled with <code class="docutils literal notranslate"><span class="pre">C=1</span> <span class="pre">CHECK=&quot;smatch</span> <span class="pre">-p=kernel&quot;</span></code>.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">fail</span></code>: <code class="docutils literal notranslate"><span class="pre">error</span></code> logged</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">warn</span></code>: <code class="docutils literal notranslate"><span class="pre">warning</span></code> logged</div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="defconfigs">
<h3>Defconfigs<a class="headerlink" href="#defconfigs" title="Link to this heading"></a></h3>
<p>If the defconfig of a target doesn’t exist, it falls back to the default configuration
of that architecture.</p>
<p>A “temporary” commit can be used to manipulate the defconfigs for faster build times.</p>
</section>
<section id="source-code-manipulation">
<h3>Source code manipulation<a class="headerlink" href="#source-code-manipulation" title="Link to this heading"></a></h3>
<p>Cocci and bash scripts at <code class="docutils literal notranslate"><span class="pre">ci/prerun</span></code> are executed right after the <code class="docutils literal notranslate"><span class="pre">.config</span></code> is generated
and before it is saved and the kernel compiled.
For the check job, they are applied right after checkout.
It allows manipulating the source code depending on the run conditions, and can be used
as “adapters” when targeting multiple branches, architecture, and so on.</p>
<p>Each cocci/bash is executed taking each touched file as the argument,
so ensure to filter on the scripts themselves which file they manipulate.
Cocci files are applied only to <code class="docutils literal notranslate"><span class="pre">.c</span></code> files.</p>
<p>Here is a simple example that changes a method argument type:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">backport.cocci</span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">@</span> <span class="n">change_arg_type</span> <span class="o">@</span>
<span class="n">identifier</span> <span class="n">func</span> <span class="o">=</span> <span class="n">adc_write_event_config</span><span class="p">;</span>
<span class="n">identifier</span> <span class="n">arg</span><span class="p">;</span>
<span class="nb">type</span> <span class="n">T</span> <span class="o">=</span> <span class="n">enum</span> <span class="n">iio_event_direction</span><span class="p">;</span>
<span class="o">@@</span>

<span class="n">func</span><span class="p">(</span><span class="o">...</span><span class="p">,</span>
<span class="o">-</span> <span class="n">T</span> <span class="n">arg</span>
<span class="o">+</span> <span class="n">enum</span> <span class="n">iio_event_direction_ex</span> <span class="n">arg</span>
<span class="p">,</span> <span class="o">...</span> <span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="setting-up-and-running">
<h2>Setting up and running<a class="headerlink" href="#setting-up-and-running" title="Link to this heading"></a></h2>
<p>In this section there are instructions to bring-up your own continuous integration,
either to run locally, in a self-hosted runner or even in a cluster.</p>
<section id="configure-podman">
<span id="conf-podman"></span><h3>Configure podman<a class="headerlink" href="#configure-podman" title="Link to this heading"></a></h3>
<p>Below are suggested instructions for setting up <code class="docutils literal notranslate"><span class="pre">podman</span></code> on a Linux environment.</p>
<p>Adjust to your preference as needed, and skip the steps marked in <span class="green">green</span>
if not using WSL2.</p>
<p>Install <code class="docutils literal notranslate"><span class="pre">podman</span></code> from your package manager.</p>
<p><span class="green">Ensure cgroup v2 on wsl2’s .wslconfig:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wsl2</span><span class="p">]</span>
<span class="n">kernelCommandLine</span> <span class="o">=</span> <span class="n">cgroup_no_v1</span><span class="o">=</span><span class="nb">all</span> <span class="n">systemd</span><span class="o">.</span><span class="n">unified_cgroup_hierarchy</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p><span class="green">Restart wsl2.</span></p>
<p>Enable podman service for your user.</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>--user<span class="w"> </span>podman.socket
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>start<span class="w"> </span>--user<span class="w"> </span>podman.socket
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Set the <code class="docutils literal notranslate"><span class="pre">DOCKER_HOST</span></code> variable on your <em>~/.bashrc</em>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">DOCKER_HOST</span><span class="o">=</span>unix://<span class="nv">$XDG_RUNTIME_DIR</span>/podman/podman.sock
</pre></div>
</div>
<section id="network-users-partitions">
<span id="podman-sssd"></span><h4>Network users &amp; partitions<a class="headerlink" href="#network-users-partitions" title="Link to this heading"></a></h4>
<p>Podman default configuration expects a local user to be able to create a user
namespace where multiple IDs are mapped and a compatible partition to use as
the storage location <code class="docutils literal notranslate"><span class="pre">graphRoot</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The ideal solution is to create a local <strong>non-root</strong> user and storage
location. Podman processes should then be started under this user UID.</p>
</div>
<p>Network systems using solutions such as <a class="reference external" href="https://sssd.io/">SSSD</a> do not
append the user to the system (is not listed in <code class="docutils literal notranslate"><span class="pre">/etc/subuid</span></code>), so automatic
user namespace is not possible. To be compatible with this configuration, a
single UID within a user space needs to be used, achieved with the
<code class="docutils literal notranslate"><span class="pre">ignore_chown_errors</span></code> parameter.</p>
<p>Normally these systems also mount an network file system (nfs) as the home folder,
which is also not supported.
In this case, the <code class="docutils literal notranslate"><span class="pre">graphRoot</span></code> location needs to be set to somewhere else
(an easy test location is <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p>
<p>This is an example of <em>~/.config/containers/storage.conf</em> to support such
environments:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[storage]</span>
<span class="na">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;overlay&quot;</span>
<span class="c1"># Set to a path in a non-nfs partition</span>
<span class="na">graphRoot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/tmp&quot;</span>

<span class="k">[storage.options.overlay]</span>
<span class="c1"># Single UID</span>
<span class="na">ignore_chown_errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</pre></div>
</div>
<p>Ensure apply with <code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">system</span> <span class="pre">migrate</span></code> and see the changed settings with
<code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">info</span></code>.</p>
<p>An alternative mitigation for nfs is to create a xfs disk image and mount, but
since mount requires a root permission it is unlikely to be helpful for most
users:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>truncate<span class="w"> </span>-s<span class="w"> </span>100g<span class="w"> </span>~/.local/share/containers-xfs.img
mkfs.xfs<span class="w"> </span>-m<span class="w"> </span><span class="nv">reflink</span><span class="o">=</span><span class="m">1</span><span class="w">  </span>~/.local/share/containers-xfs.img<span class="w"> </span>-m<span class="w"> </span><span class="nv">bigtime</span><span class="o">=</span><span class="m">1</span>,inobtcount<span class="o">=</span><span class="m">1</span><span class="w"> </span>-i<span class="w"> </span><span class="nv">nrext64</span><span class="o">=</span><span class="m">0</span>
sudo<span class="w"> </span>mount<span class="w"> </span>~/.local/share/containers-xfs.img<span class="w"> </span>~/.local/share/containers
</pre></div>
</div>
</section>
</section>
<section id="build-the-container-image">
<span id="image-podman"></span><h3>Build the container image<a class="headerlink" href="#build-the-container-image" title="Link to this heading"></a></h3>
<p>To build the container image, use your favorite container engine:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/linux
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podman<span class="w"> </span>build<span class="w"> </span>--tag<span class="w"> </span>adi/linux:latest<span class="w"> </span>ci
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>You may want to build the container in a host, where you have all your tools installed,
and then deploy to a server.
In this case, export the image and then import on the server:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>user@host:~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podman<span class="w"> </span>save<span class="w"> </span>-o<span class="w"> </span>adi-linux.tar<span class="w"> </span>adi/linux:latest
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>user@host:~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scp<span class="w"> </span>adi-linux.tar<span class="w"> </span>server:/tmp/
</pre></div>
</div>
<div class="clear-left"></div></div></div><div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>admin@server:/tmp$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podman<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>adi-linux.tar
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Or if you are feeling adventurous:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>user@host:~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podman<span class="w"> </span>save<span class="w"> </span>adi/linux:latest<span class="w"> </span><span class="p">|</span><span class="w"> </span>ssh<span class="w"> </span>server<span class="w"> </span><span class="s2">&quot;cat - | podman load&quot;</span>
</pre></div>
</div>
<div class="clear-left"></div></div></div></section>
<section id="interactive-run">
<span id="id1"></span><h3>Interactive run<a class="headerlink" href="#interactive-run" title="Link to this heading"></a></h3>
<p>The <a class="icon git reference external" href="https://github.com/analogdevicesinc/doctools/tree/main/ci/scripts/podman-run.sh">podman-run.sh</a>
is a suggested container command to interactive login into an image, mounting
the provided path.</p>
<p>You can leverage it to compile/runs checks using persistent cache, for example:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pdr<span class="w"> </span>adi/linux:v1<span class="w"> </span>.
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>gcc-14<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-suse-linux-gnueabi-<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>xilinx_zynq_defconfig
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select highlight-text notranslate"><div class="highlight"><pre><span></span>#
# configuration written to .config
#
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>-j<span class="k">$(($(</span>nproc<span class="k">)</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="w"> </span><span class="nv">UIMAGE_LOADADDR</span><span class="o">=</span>0x8000
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select highlight-text notranslate"><div class="highlight"><pre><span></span>UPD     include/generated/compile.h
CALL    scripts/checksyscalls.sh
CC      init/version.o
AR      init/built-in.a
[ ... ]
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Or:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pdr<span class="w"> </span>adi/linux:v1<span class="w"> </span>.
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>ci/build.sh
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">base_sha</span><span class="o">=</span>@~2<span class="p">;</span><span class="w"> </span><span class="nv">head_sha</span><span class="o">=</span>@
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_checkpatch
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Significantly speeding up interactive testing.</p>
</section>
<section id="self-hosted-runner">
<span id="podman-run"></span><h3>Self-hosted runner<a class="headerlink" href="#self-hosted-runner" title="Link to this heading"></a></h3>
<p>To host your <a class="reference external" href="https://github.com/actions/runner">GitHub Actions Runner</a>,
set up your secrets:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># e.g. analogdevicesinc/linux</span>
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">printf</span><span class="w"> </span>ORG_REPOSITORY<span class="w"> </span><span class="p">|</span><span class="w"> </span>podman<span class="w"> </span>secret<span class="w"> </span>create<span class="w"> </span>public_linux_org_repository<span class="w"> </span>-
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># e.g. MyVerYSecRunnerToken</span>
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">printf</span><span class="w"> </span>RUNNER_TOKEN<span class="w"> </span><span class="p">|</span><span class="w"> </span>podman<span class="w"> </span>secret<span class="w"> </span>create<span class="w"> </span>public_linux_runner_token<span class="w"> </span>-
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>The runner token is obtained from the GUI at <code class="docutils literal notranslate"><span class="pre">github.com/&lt;org&gt;/&lt;repository&gt;/settings/actions/runners/new</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">github_token</span></code> from <a class="reference internal" href="#cluster-podman"><span class="std std-ref">Self-hosted cluster</span></a> is set, the runner_token
is ignored and a new one is requested.</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/linux$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podman<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--secret<span class="w"> </span>public_linux_org_repository,type<span class="o">=</span>env,target<span class="o">=</span>org_repository<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--secret<span class="w"> </span>public_linux_runner_token,type<span class="o">=</span>env,target<span class="o">=</span>runner_token<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--env<span class="w"> </span><span class="nv">runner_labels</span><span class="o">=</span>v1,big_cpu<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>adi/linux:latest
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>The environment variable runner_labels (comma-separated), set the runner labels.
If not provided on the Containerfile as <code class="docutils literal notranslate"><span class="pre">ENV</span> <span class="pre">runner_labels=&lt;labels,&gt;</span></code> or as argument
<code class="docutils literal notranslate"><span class="pre">--env</span> <span class="pre">runner_labels=&lt;labels,&gt;</span></code>, it defaults to <code class="docutils literal notranslate"><span class="pre">v1</span></code>.
Most of the times, you want to use the Containerfile-set environment variable.</p>
<p>If you are in an environment as described in <a class="reference internal" href="#podman-sssd"><span class="std std-ref">Network users &amp; partitions</span></a>, append these flags
to every <code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">run</span></code> command:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--user</span> <span class="pre">root</span></code>: due to <code class="docutils literal notranslate"><span class="pre">ignore_chown_errors</span></code> allowing a single user mapping,
this user is root (0). Please note that this the container’s root user and in
most images is the only available user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--env</span> <span class="pre">RUNNER_ALLOW_RUNASROOT=1</span></code>: suppresses the GitHub Action runner “Must
not run with sudo”. Again, is the container’s root.</p></li>
</ul>
</section>
<section id="self-hosted-cluster">
<span id="cluster-podman"></span><h3>Self-hosted cluster<a class="headerlink" href="#self-hosted-cluster" title="Link to this heading"></a></h3>
<p>To host a cluster of self-hosted runners, the recommended approach is to use
systemd services, instead of for example, podman-compose.</p>
<p>Below is a suggested systemd service at <em>~/.config/systemd/user/podman-public-linux&#64;.service</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Podman</span> <span class="n">public</span> <span class="n">linux</span> <span class="n">ci</span> <span class="o">%</span><span class="n">i</span>
<span class="n">Wants</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">on</span><span class="o">-</span><span class="n">success</span>
<span class="n">ExecStartPre</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/%</span><span class="n">t</span><span class="o">/%</span><span class="n">n</span><span class="o">-</span><span class="n">pid</span> <span class="o">/%</span><span class="n">t</span><span class="o">/%</span><span class="n">n</span><span class="o">-</span><span class="n">cid</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">podman</span> <span class="n">run</span> \
          <span class="o">--</span><span class="n">env</span> <span class="n">name_label</span><span class="o">=%</span><span class="n">H</span><span class="o">-%</span><span class="n">i</span> \
          <span class="o">--</span><span class="n">secret</span> <span class="n">public_linux_org_repository</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">env</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="n">org_repository</span> \
          <span class="o">--</span><span class="n">secret</span> <span class="n">public_linux_runner_token</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">env</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="n">runner_token</span> \
          <span class="o">--</span><span class="n">conmon</span><span class="o">-</span><span class="n">pidfile</span> <span class="o">/%</span><span class="n">t</span><span class="o">/%</span><span class="n">n</span><span class="o">-</span><span class="n">pid</span> <span class="o">--</span><span class="n">cidfile</span> <span class="o">/%</span><span class="n">t</span><span class="o">/%</span><span class="n">n</span><span class="o">-</span><span class="n">cid</span> \
          <span class="o">--</span><span class="n">label</span> <span class="s2">&quot;io.containers.autoupdate=local&quot;</span> \
          <span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">public_linux_</span><span class="o">%</span><span class="n">i</span> \
          <span class="o">--</span><span class="n">memory</span><span class="o">-</span><span class="n">swap</span><span class="o">=</span><span class="mi">20</span><span class="n">g</span> \
          <span class="o">--</span><span class="n">memory</span><span class="o">=</span><span class="mi">16</span><span class="n">g</span> \
          <span class="o">--</span><span class="n">cpus</span><span class="o">=</span><span class="mi">4</span> \
          <span class="o">-</span><span class="n">d</span> <span class="n">adi</span><span class="o">/</span><span class="n">linux</span><span class="p">:</span><span class="n">latest</span> <span class="n">top</span>
<span class="n">ExecStop</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;/usr/bin/podman rm -f `cat /%t/%n-cid`&quot;</span>
<span class="n">TimeoutStopSec</span><span class="o">=</span><span class="mi">600</span>
<span class="n">Type</span><span class="o">=</span><span class="n">forking</span>
<span class="n">PIDFile</span><span class="o">=/%</span><span class="n">t</span><span class="o">/%</span><span class="n">n</span><span class="o">-</span><span class="n">pid</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>Remember to <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">--user</span> <span class="pre">daemon-reload</span></code> after modifying.
With <a class="reference external" href="https://docs.podman.io/en/latest/markdown/podman-auto-update.1.html">autoupdate</a>,
if the image-digest of the container and local storage differ,
the local image is considered to be newer and the systemd unit gets restarted.</p>
<p>Instead of passing runner_token, you can also pass a github_token to generate
the runner_token on demand.
Using the github_token is the recommended approach because during clean-up the original
runner_token may have expired already.</p>
<p>Tune the limit flags for your needs.
The <code class="docutils literal notranslate"><span class="pre">--cpus</span></code> flag requires a kernel with <code class="docutils literal notranslate"><span class="pre">CONFIG_CFS_BANDWIDTH</span></code> enabled.
You can check with <code class="docutils literal notranslate"><span class="pre">zgrep</span> <span class="pre">CONFIG_CFS_BANDWIDTH=</span> <span class="pre">/proc/config.gz</span></code>.</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># e.g. MyVerYSecRetToken</span>
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">printf</span><span class="w"> </span>GITHUB_TOKEN<span class="w"> </span><span class="p">|</span><span class="w"> </span>podman<span class="w"> </span>secret<span class="w"> </span>create<span class="w"> </span>public_linux_github_token<span class="w"> </span>-
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Alternatively, you can also mount the <code class="docutils literal notranslate"><span class="pre">runner_token</span></code> into
<code class="docutils literal notranslate"><span class="pre">/run/secrets/runner_token</span></code> and have it read when necessary.
However, please note, just like the GitHub Actions generated <code class="docutils literal notranslate"><span class="pre">GITHUB_TOKEN</span></code>,
the path <code class="docutils literal notranslate"><span class="pre">/run/secrets/runner_token</span></code> can be read by workflows,
while the previous option is removed from the environment prior executing
the GitHub Actions runtime.</p>
<p>The order of precedence for authentication token is:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">github_token</span></code>: environment variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runner_token</span></code>: plain text at <em>/run/secrets/runner_token</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runner_token</span></code>: environment variable.</p></li>
</ol>
<p>Please understand the security implications and ensure the token secrecy,
by for example, require manual approval for running workflows PRs from
third party sources and don’t relax <code class="docutils literal notranslate"><span class="pre">runner</span></code> user permissions.</p>
<p>The required GitHub Fine-Grained token permission should be set as follows:</p>
<p>For <a class="reference external" href="https://docs.github.com/en/rest/actions/self-hosted-runners?apiVersion=2022-11-28#create-a-registration-token-for-a-repository--fine-grained-access-tokens">repository runner</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">administration:write</span></code>: “Administration” repository permissions (write).</p></li>
</ul>
<p>For <a class="reference external" href="https://docs.github.com/en/rest/actions/self-hosted-runners?apiVersion=2022-11-28#create-a-registration-token-for-an-organization">org runner</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">organization_self_hosted_runners:write</span></code>: “Self-hosted runners” organization permissions (write).</p></li>
<li><p>The user needs to be an org-level admin.</p></li>
</ul>
<p>Then update the systemd service.</p>
<p>Enable and start the service</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>--user<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>podman-public-linux@0.service
systemctl<span class="w"> </span>--user<span class="w"> </span>start<span class="w"> </span>podman-public-linux@0.service
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>User services are terminated on logout, unless you define
<code class="docutils literal notranslate"><span class="pre">loginctl</span> <span class="pre">enable-linger</span> <span class="pre">&lt;your-user&gt;</span></code> first.</p>
</div>
</section>
</section>
</section>


          </div>
              <div class="related">
                &nbsp;
    <a href="drivers/adc/index.html" title="Previous document (Alt+Shift+LeftArrow)" class="prev">ADC</a>
    <div></div>
              </div>
          
        </div>
      </div>
  </div>

  <label id="cancel-area-show-toc" for="input-show-toc"></label>
  <label id="cancel-area-show-localtoc" for="input-show-localtoc"></label>
    <footer>
      &#169;2025, Analog Devices, Inc.
      
      |
      Made with <a href="https://www.sphinx-doc.org/">Sphinx</a>
      &amp; <a href="https://github.com/analogdevicesinc/doctools">Doctools</a>
      
    </footer>
  </body>
</html>