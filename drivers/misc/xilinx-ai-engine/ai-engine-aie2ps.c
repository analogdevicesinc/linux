// SPDX-License-Identifier: GPL-2.0
/*
 * Xilinx AI Engine driver AIE-2PS device specific implementation
 *
 * Copyright (C) 2023 - 2025 Advanced Micro Devices, Inc.
 */

#include <linux/bitfield.h>
#include <linux/firmware/xlnx-zynqmp.h>
#include <linux/io.h>
#include <linux/slab.h>
#include <linux/xlnx-ai-engine.h>

#include "ai-engine-internal.h"

#define AIE2PS_ARRAY_SHIFT	32U
#define AIE2PS_COL_SHIFT	25U
#define AIE2PS_ROW_SHIFT	20U

#define NUM_TYPES_OF_MEM	6U

#define NUM_MODS_CORE_TILE	2U
#define NUM_MODS_MEM_TILE	1U
#define NUM_MODS_SHIMPL_TILE	1U

/*
 * Number of resources per module
 */
#define AIE2PS_NUM_PERF_TILE_CORE_MOD		4U
#define AIE2PS_NUM_USEREVENT_TILE_CORE_MOD	4U
#define AIE2PS_NUM_TRACECONTROL_TILE_CORE_MOD	1U
#define AIE2PS_NUM_PCEVENT_TILE_CORE_MOD	4U
#define AIE2PS_NUM_SSSELECT_TILE_CORE_MOD	8U
#define AIE2PS_NUM_BROADCAST_TILE_CORE_MOD	16U
#define AIE2PS_NUM_COMBOEVENT_TILE_CORE_MOD	4U
#define AIE2PS_NUM_GROUPEVENTS_TILE_CORE_MOD	9U

#define AIE2PS_NUM_PERF_TILE_MEM_MOD		2U
#define AIE2PS_NUM_USEREVENT_TILE_MEM_MOD	4U
#define AIE2PS_NUM_TRACECONTROL_TILE_MEM_MOD	1U
#define AIE2PS_NUM_PCEVENT_TILE_MEM_MOD		0U
#define AIE2PS_NUM_SSSELECT_TILE_MEM_MOD	0U
#define AIE2PS_NUM_BROADCAST_TILE_MEM_MOD	16U
#define AIE2PS_NUM_COMBOEVENT_TILE_MEM_MOD	4U
#define AIE2PS_NUM_GROUPEVENTS_TILE_MEM_MOD	8U

#define AIE2PS_NUM_PERF_MEM_MOD			4U
#define AIE2PS_NUM_USEREVENT_MEM_MOD		2U
#define AIE2PS_NUM_TRACECONTROL_MEM_MOD		1U
#define AIE2PS_NUM_PCEVENT_MEM_MOD		0U
#define AIE2PS_NUM_SSSELECT_MEM_MOD		8U
#define AIE2PS_NUM_BROADCAST_MEM_MOD		16U
#define AIE2PS_NUM_COMBOEVENT_MEM_MOD		4U
#define AIE2PS_NUM_GROUPEVENTS_MEM_MOD		9U

#define AIE2PS_NUM_PERF_PL_MOD			2U
#define AIE2PS_NUM_USEREVENT_PL_MOD		2U
#define AIE2PS_NUM_TRACECONTROL_PL_MOD		1U
#define AIE2PS_NUM_PCEVENT_PL_MOD		0U
#define AIE2PS_NUM_SSSELECT_PL_MOD		8U
#define AIE2PS_NUM_BROADCAST_PL_MOD		16U
#define AIE2PS_NUM_COMBOEVENT_PL_MOD		4U
#define AIE2PS_NUM_GROUPEVENTS_PL_MOD		6U

/*
 * Register offsets
 */
#define AIE2PS_SHIMNOC_BD0_0_REGOFF			0x00009000U
#define AIE2PS_SHIMNOC_BD15_7_REGOFF			0x000092ecU
#define AIE2PS_SHIMNOC_LOCK_REGOFF			0x00000000U
#define AIE2PS_SHIMNOC_LOCK_OVERFLOW_REGOFF		0x00000120U
#define AIE2PS_SHIMNOC_LOCK_UNDERFLOW_REGOFF		0x00000128U
#define AIE2PS_SHIMNOC_DMA_S2MM_STATUS_REGOFF		0x00009320U
#define AIE2PS_SHIMNOC_DMA_MM2S_STATUS_REGOFF		0x00009328U
#define AIE2PS_SHIMNOC_UCMOD_CORE_CTRL_REGOFF		0x000C0004U

#define AIE2PS_SHIMPL_BISRCACHE_CTRL_REGOFF		0x00036000U
#define AIE2PS_SHIMPL_COLCLOCK_CTRL_REGOFF		0x0007ff20U
#define AIE2PS_SHIMPL_EVENT_BC0_REGOFF			0x00034010U
#define AIE2PS_SHIMPL_EVENT_BC_A_BLOCK_SOUTH_SET	0x00034050U
#define AIE2PS_SHIMPL_EVENT_BC_B_BLOCK_SOUTH_SET	0x00034090U
#define AIE2PS_SHIMPL_EVENT_STATUS0_REGOFF		0x00034200U
#define AIE2PS_SHIMPL_GROUP0_REGOFF			0x00034500U
#define AIE2PS_SHIMPL_L1INTR_MASK_A_REGOFF		0x00035000U
#define AIE2PS_SHIMPL_L1INTR_BLOCK_NORTH_B_REGOFF	0x00035050U
#define AIE2PS_SHIMPL_TILECTRL_REGOFF			0x0007ff40U
#define AIE2PS_SHIMPL_MODRESET_CTRL_0_REGOFF		0x0007ff10U
#define AIE2PS_SHIMPL_MODRESET_CTRL_1_REGOFF		0x0007ff14U

#define AIE2PS_MEMORY_BD0_0_REGOFF			0x000A0000U
#define AIE2PS_MEMORY_GROUP0_REGOFF			0x00094500U
#define AIE2PS_MEMORY_GROUPERROR_REGOFF			0x00094518U
#define AIE2PS_MEMORY_TILECTRL_REGOFF			0x000fff20U
#define AIE2PS_MEMORY_EVENT_BC0_REGOFF			0x00094010U
#define AIE2PS_MEMORY_EVENT_BC_A_BLOCK_SOUTH_SET	0x00094050U
#define AIE2PS_MEMORY_EVENT_BC_B_BLOCK_SOUTH_SET	0x00094090U
#define AIE2PS_MEMORY_EVENT_STATUS0_REGOFF		0x00094200U
#define AIE2PS_MEMORY_MEMCTRL_REGOFF			0x00096048U
#define AIE2PS_MEMORY_LOCK_REGOFF			0x000C0000U
#define AIE2PS_MEMORY_LOCK_OVERFLOW_REGOFF		0x000C0420U
#define AIE2PS_MEMORY_LOCK_UNDERFLOW_REGOFF		0x000C0428U
#define AIE2PS_MEMORY_DMA_S2MM_STATUS_REGOFF		0x000A0660U
#define AIE2PS_MEMORY_DMA_MM2S_STATUS_REGOFF		0x000A0680U

#define AIE2PS_TILE_COREMOD_BMLL0_PART1_REGOFF		0x00030000U
#define AIE2PS_TILE_COREMOD_BMHH7_PART4_REGOFF		0x000307F0U
#define AIE2PS_TILE_COREMOD_X0_PART1_REGOFF		0x00031800U
#define AIE2PS_TILE_COREMOD_X11_PART4_REGOFF		0x00031AF0U
#define AIE2PS_TILE_COREMOD_LDFIFOL0_PART1_REGOFF	0x00032400U
#define AIE2PS_TILE_COREMOD_FIFOXTRA_PART4_REGOFF	0x000325B0U
#define AIE2PS_TILE_COREMOD_EG0_REGOFF			0x00032600U
#define AIE2PS_TILE_COREMOD_EG11_REGOFF			0x000326B0U
#define AIE2PS_TILE_COREMOD_F0_REGOFF			0x00032700U
#define AIE2PS_TILE_COREMOD_F11_REGOFF			0x000327B0U
#define AIE2PS_TILE_COREMOD_R0_REGOFF			0x00032800U
#define AIE2PS_TILE_COREMOD_S3_REGOFF			0x00032CB0U
#define AIE2PS_TILE_COREMOD_SP_REGOFF			0x00032D20U
#define AIE2PS_TILE_COREMOD_GROUPERROR_REGOFF		0x00034510U
#define AIE2PS_TILE_COREMOD_TILECTRL_REGOFF		0x00060020U
#define AIE2PS_TILE_COREMOD_GROUP0_REGOFF		0x00034500U
#define AIE2PS_TILE_COREMOD_EVENT_BC0_REGOFF		0x00034010U
#define AIE2PS_TILE_COREMOD_EVENT_BC_A_BLOCK_SOUTH_SET	0x00034050U
#define AIE2PS_TILE_COREMOD_EVENT_STATUS0_REGOFF	0x00034200U
#define AIE2PS_TILE_COREMOD_MEMCTRL_REGOFF		0x00036070U
#define AIE2PS_TILE_COREMOD_MODRESETCTRL_REGOFF		0x00060010U
#define AIE2PS_TILE_COREMOD_CORE_STATUS_REGOFF		0x00038004U
#define AIE2PS_TILE_COREMOD_ERROR_HALT_EVENT_REGOFF	0x00038034U
#define AIE2PS_TILE_COREMOD_CORE_PC_REGOFF		0x00032d00U
#define AIE2PS_TILE_COREMOD_CORE_SP_REGOFF		0x00032d20U
#define AIE2PS_TILE_COREMOD_CORE_LR_REGOFF		0x00032d30U
#define AIE2PS_TILE_MEMMOD_BD0_0_REGOFF			0x0001D000U
#define AIE2PS_TILE_MEMMOD_GROUPERROR_REGOFF		0x00014514U
#define AIE2PS_TILE_MEMMOD_GROUP0_REGOFF		0x00014500U
#define AIE2PS_TILE_MEMMOD_EVENT_BC0_REGOFF		0x00014010U
#define AIE2PS_TILE_MEMMOD_EVENT_BC_B_BLOCK_SOUTH_SET	0x00014050U
#define AIE2PS_TILE_MEMMOD_EVENT_STATUS0_REGOFF		0x00014200U
#define AIE2PS_TILE_MEMMOD_MEMCTRL_REGOFF		0x00016010U
#define AIE2PS_TILE_MEMMOD_LOCK_REGOFF			0x0001F000U
#define AIE2PS_TILE_MEMMOD_LOCK_OVERFLOW_REGOFF		0x0001F120U
#define AIE2PS_TILE_MEMMOD_LOCK_UNDERFLOW_REGOFF	0x0001F128U
#define AIE2PS_TILE_MEMMOD_DMA_S2MM_STATUS_REGOFF	0x0001DF00U
#define AIE2PS_TILE_MEMMOD_DMA_MM2S_STATUS_REGOFF	0x0001DF10U

/*
 * Register masks
 */
#define AIE2PS_SHIMPL_COLCLOCK_CTRL_MASK		GENMASK(1, 0)

/* Macros to define size of a sysfs binary attribute */
#define AIE2PS_PART_SYSFS_CORE_BINA_SIZE	0x4000		/* 16KB */
#define AIE2PS_PART_SYSFS_LOCK_BINA_SIZE	0x28000		/* 160KB */
#define AIE2PS_PART_SYSFS_ERROR_BINA_SIZE	0x4000		/* 16KB */
#define AIE2PS_PART_SYSFS_DMA_BINA_SIZE		0xC800		/* 50KB */
#define AIE2PS_PART_SYSFS_STATUS_BINA_SIZE	0x3c000		/* 240KB */
