#!/bin/sh
# SPDX-License-Identifier: GPL-2.0
# description: Generic dynamic event - add/remove wprobe events
# requires: dynamic_events "w[:[<group>/][<event>]] [r|w|rw]@<addr>[:<len>]":README

echo 0 > events/enable
echo > dynamic_events

# Use jiffies as a variable that is frequently written to.
TARGET=jiffies

echo "w:my_wprobe w@$TARGET" >> dynamic_events

grep -q my_wprobe dynamic_events
if [ $? -ne 0 ]; then
    echo "Failed to create wprobe event"
    exit_fail
fi

test -d events/wprobes/my_wprobe
if [ $? -ne 0 ]; then
    echo "Failed to create wprobe event directory"
    exit_fail
fi

echo 1 > events/wprobes/my_wprobe/enable

# Check if the event is enabled
cat events/wprobes/my_wprobe/enable | grep -q 1
if [ $? -ne 0 ]; then
    echo "Failed to enable wprobe event"
    exit_fail
fi

# Let some time pass to trigger the breakpoint
sleep 1

# Check if we got any trace output
if !grep -q my_wprobe trace; then
    echo "wprobe event was not triggered"
fi

echo 0 > events/wprobes/my_wprobe/enable

# Check if the event is disabled
cat events/wprobes/my_wprobe/enable | grep -q 0
if [ $? -ne 0 ]; then
    echo "Failed to disable wprobe event"
    exit_fail
fi

echo "-:my_wprobe" >> dynamic_events

! grep -q my_wprobe dynamic_events
if [ $? -ne 0 ]; then
    echo "Failed to remove wprobe event"
    exit_fail
fi

! test -d events/wprobes/my_wprobe
if [ $? -ne 0 ]; then
    echo "Failed to remove wprobe event directory"
    exit_fail
fi

clear_trace

exit 0
